name: Transfer Release Assets

on:
  workflow_dispatch:
    inputs:
      down_url:
        description: 'GitHub releaseçš„ä¸‹è½½åœ°å€'
        required: true
        type: string
      storage_branch:
        description: 'ç”¨äºå­˜å‚¨æ–‡ä»¶çš„åˆ†æ”¯'
        required: false
        default: '_transfer'
        type: string

permissions:
  contents: write

jobs:
  transfer:
    runs-on: ubuntu-latest
    steps:
      - name: check workflow inputs
        id: check_url
        run: |
          # éªŒè¯down_urlæ˜¯å¦ç¬¦åˆGitHub releaseä¸‹è½½åœ°å€æ ¼å¼
          if [[ ! ${{ github.event.inputs.down_url }} =~ ^https://github\.com/[^/]+/[^/]+/releases/download/[^/]+/[^/]+$ ]]; then
            echo "::error::down_urlæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æä¾›æœ‰æ•ˆçš„GitHub releaseä¸‹è½½åœ°å€"
            exit 1
          fi
          
          # è§£æURLè·å–å¿…è¦ä¿¡æ¯
          URL="${{ github.event.inputs.down_url }}"
          
          # æå–ç”¨æˆ·åå’Œä»“åº“å (ä¾‹å¦‚: oldj/SwitchHosts)
          REPO_PART=$(echo "$URL" | awk -F'github.com/' '{print $2}' | awk -F'/releases' '{print $1}')
          USER=$(echo "$REPO_PART" | awk -F'/' '{print $1}')
          REPO=$(echo "$REPO_PART" | awk -F'/' '{print $2}')
          
          # æå–ç‰ˆæœ¬å· (ä¾‹å¦‚: v4.2.0)
          VERSION=$(echo "$URL" | awk -F'/download/' '{print $2}' | awk -F'/' '{print $1}')
          
          # æå–æ–‡ä»¶å (ä¾‹å¦‚: SwitchHosts_windows_portable_x64_4.2.0.6119.exe)
          FILENAME=$(basename "$URL")
          
          # æ„å»ºç›®æ ‡è·¯å¾„ (ä¾‹å¦‚: oldj_SwitchHosts/v4.2.0)
          TARGET_PATH="${USER}_${REPO}/${VERSION}"
          FULL_PATH="${TARGET_PATH}/${FILENAME}"
          
          # è®¾ç½®è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "target_path=$TARGET_PATH" >> $GITHUB_OUTPUT
          echo "full_path=$FULL_PATH" >> $GITHUB_OUTPUT
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT

      - name: checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: åˆ›å»ºç›®æ ‡åˆ†æ”¯ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        run: |
          BRANCH="${{ github.event.inputs.storage_branch }}"
          # æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨äºè¿œç¨‹
          if ! git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null 2>&1; then
            # åˆ†æ”¯ä¸å­˜åœ¨ï¼Œä»é»˜è®¤åˆ†æ”¯åˆ›å»ºæ–°åˆ†æ”¯
            git checkout -b "$BRANCH"
            # åˆ›å»ºåˆå§‹README.md
            echo "# è½¬ç§»æ–‡ä»¶å­˜å‚¨åº“" > README.md
            echo "" >> README.md
            echo "| ä¸‹è½½æ—¶é—´ï¼ˆGMT+8ï¼‰ | ä¸‹è½½é“¾æ¥ | å½“å‰è·¯å¾„ |" >> README.md
            echo "| :--------------- | :------- | :------- |" >> README.md
            git add README.md
            # ä½¿ç”¨ä»“åº“é»˜è®¤çš„Actorä¿¡æ¯
            git config --global user.email "${{ github.actor }}@users.noreply.github.com"
            git config --global user.name "${{ github.actor }}"
            git commit -m "åˆå§‹åŒ–${BRANCH}åˆ†æ”¯"
            git push -u origin "$BRANCH"
          else
            # åˆ†æ”¯å­˜åœ¨ï¼Œç›´æ¥æ£€å‡º
            git checkout "$BRANCH"
          fi

      - name: åˆ›å»ºç›®æ ‡æ–‡ä»¶å¤¹
        run: |
          mkdir -p ${{ steps.check_url.outputs.target_path }}

      - name: ä¸‹è½½æ–‡ä»¶
        run: |
          wget -O ${{ steps.check_url.outputs.full_path }} ${{ github.event.inputs.down_url }}

      - name: æ›´æ–°README.md
        run: |
          # è·å–å½“å‰æ—¶é—´ï¼ˆGMT+8ï¼‰
          CURRENT_TIME=$(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M:%S")
          
          # æ„å»ºæ–°è¡Œ
          NEW_ROW="| ${CURRENT_TIME} | [åŸå§‹é“¾æ¥](${{ github.event.inputs.down_url }}) | ${{ steps.check_url.outputs.full_path }} |"
          
          # åœ¨è¡¨æ ¼åæ·»åŠ æ–°è¡Œ
          sed -i "/| :------- |/a ${NEW_ROW}" README.md

      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        run: |
          # ä½¿ç”¨ä»“åº“é»˜è®¤çš„Actorä¿¡æ¯
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git config --global user.name "${{ github.actor }}"
          git add .
          git commit -m "æ·»åŠ æ–‡ä»¶: ${{ steps.check_url.outputs.full_path }}"
          git push origin ${{ github.event.inputs.storage_branch }}

      - name: è¾“å‡ºæˆåŠŸä¿¡æ¯
        run: |
          echo "âœ… ä¸Šä¼ æˆåŠŸ!"
          echo "ğŸ“‚ æ–‡ä»¶è·¯å¾„: ${{ steps.check_url.outputs.full_path }}"
          echo "ğŸŒ¿ å­˜å‚¨åˆ†æ”¯: ${{ github.event.inputs.storage_branch }}"
    
